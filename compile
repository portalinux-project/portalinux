#!/bin/sh
# SPDX-License-Identifier: GPL-2.0-or-later
set -e

# TODO: make modules only be sourced when they are needed
# TODO: refactor code in modules to use _exec() and _compile_pkg() when possible and useful
# TODO: maybe make a _timed_exec() and/or _timed_run() function to potentialy remove some additional redundant lines of code
# TODO: document the usage and params of every function
# TODO: document every modules needed dependencies in comments

alias source="." # make source work on posix shells
pldir="$(dirname $(realpath $0))"
plfiles="$pldir/pl-files"

source "$plfiles/compile-modules/defaults.sh"

_exit_handler(){
	exit_num=$?

	if [ $exit_num -ne 0 ]; then
		if [ $exit_num -eq 130 ]; then
			echo "Interrupt!"
		else
			printf "\nSomething wrong happened. Please check $(basename $logfile) or the output above for more info.\n"
		fi
	fi

	exit $exit_num
}

_exec(){
	set +e
	printf "$1..."
	if [ "$4" = "no-silent" ] || [ "$3" = "no-silent" ]; then
		script -qeac "$2" "$logfile"
	else
		script -qeac "$2 2>&1" "$logfile" >/dev/null
	fi
	errno=$?
	if [ $errno -ne 0 ]; then
		echo "Error!"
		if [ "$3" = "" ]; then
			$3
		fi
		exit $errno
	fi
	echo "Done."
	set -e
}

_compile_pkg(){
	if [ ! -r "$1" ]; then
		cd "$2"
		if [ ! -r "$2/Makefile" ]; then
			mkdir -p "build" && cd "build"
		fi

		if [ ! -r "./Makefile" ] || [ "$exec_conf" = "y" ]; then
			if [ "$dir" = "" ]; then
				dir=".."
			fi
			_exec "$3" "$dir/configure $4"
		fi

		while [ $# -gt 4 ]; do
			_exec "$5" "make -j$threads $6"
			shift 2
		done
	fi
}

source "$plfiles/compile-modules/pkg/get_names.sh"

_generate_stuff(){
	case $1 in
		"musl")
			if [ "$arch" != "aarch64" ]; then
				echo $linux_arch
			else
				echo "aarch64"
			fi
			;;
		"pkg_ver")
			set +e
			pkg=$2
			if [ "$2" = "musl-libc-headers" ]; then
				pkg="musl"
			elif [ "$2" = "gnu-libc-headers" ]; then
				pkg="glibc"
			elif [ "$2" = "libstdc++" ]; then
				pkg="gcc"
			elif [ "$2" = "linux-headers" ]; then
				pkg="linux"
			fi
			set -e

			pkg_dir=$(ls $build | grep "$pkg")
			echo "$pkg_dir" | rev | cut -d- -f1 | rev
			;;
		"libdir")
			set +e
			if [ $(echo "$arch" | grep -c 64) -ne 0 ]; then
				libdir="lib64"
			fi
			set -e
			;;
	esac
}

source "$plfiles/compile-modules/clean.sh"
source "$plfiles/compile-modules/runtime_calc.sh"

_parse_platform(){
	set +e
	case $1 in
		android32 | earm)
			specific_arch="armv7"
			dist="musl"
			;;
		android64 | earm64)
			specific_arch="aarch64"
			dist="musl"
			;;
		pc | pc32)
			specific_arch="i486"
			dist="musl"
			;;
		pc64)
			specific_arch="x86_64"
			dist="gnu"
			;;
		*)
			if [ -f "$pldir/custom-platforms" ]; then
				. $pldir/custom-platforms $specific_arch
			fi

			if [ "$specific_arch" = "$dist" ]; then
				echo "Error: Unknown platform"
				exit 5
			fi
			;;
	esac
	set -e
}

_target_system(){
	specific_arch=$(echo $2 | cut -d- -f1)
	dist=$(echo $2 | cut -d- -f2)

	if [ "$specific_arch" = "$dist" ]; then
		_parse_platform $1
	fi

	if [ $(echo "$specific_arch" | grep -c arm) -ne 0 ]; then
		arch="arm"
		abi="eabi"
		linux_arch="$arch"
		with_aoc="--with-arch=$specific_arch"
		if [ $(echo "$specific_arch" | grep -c 7) -ne 0 ]; then
			abi="eabihf"
		fi
	elif [ $(echo "$specific_arch" | grep -c 86) -ne 0 ]; then
		arch="$specific_arch"
		if [ $(echo "$specific_arch" | grep -c i) -ne 0 ]; then
			linux_arch="i386"
		else
			linux_arch="x86_64"
		fi
	else
		arch="$specific_arch"
		if [ "$specific_arch" = "aarch64" ]; then
			linux_arch="arm64"
		else
			linux_arch="$arch"
		fi

		if [ "$arch" = "powerpc" ]; then
			with_aoc="--with-cpu=$specific_arch"
		fi
	fi

	compile_target="$arch-pocket-linux-$dist$abi"
}

setup_toolchain(){
	if [ "$LLVM" = "1" ]; then
		source "$plfiles/compile-modules/llvm.sh"
	else
		source "$plfiles/compile-modules/gcc.sh"
	fi

	compile_toolchain
}

source "$plfiles/compile-modules/rootfs.sh"

compile_extra_pkgs(){
	if [ ! -r "$output_rootfs/usr/bin/pl-install" ]; then
		compile_rootfs
	else
		_get_pkg_names $dist
	fi
	common_flags="--prefix=/opt --host=$compile_target"
	dev_stuff="$common_flags --disable-multilib --with-sysroot=/ --with-build-sysroot=$output_rootfs --with-native-system-header-dir=/opt/include"

	printf "Creating build folders..."
	for i in libstdc++ gcc linux-headers binutils bash make ncurses nano; do
		mkdir -p "$output/$i/files"
		printf "."
	done
	echo "Done"

	# libgcc and libstdc++
	_setup_gcc rfs
	_compile_pkg "$output/libstdc++/files/opt" "$gcc_dir" "Configuring GCC" "$dev_stuff $extra_gcc_flags --disable-bootstrap --disable-libstdcxx-debug --enable-languages=c,c++ --disable-libsanitizer" "Compiling GCC" "" "Packaging GCC C/C++ Compilers" "install-strip-gcc DESTDIR=$output/gcc/files" "Packaging libgcc" "install-strip-target-libgcc DESTDIR=$output/libstdc++/files" "Packaging libstdc++" "install-strip-target-libstdc++-v3 DESTDIR=$output/libstdc++/files"
	rm "$toolchain_prefix/bin/cc" -f
	rm "$toolchain_prefix/bin/c++" -f

	# linux headers
	if [ ! -d "$output/linux-headers/files/opt" ]; then
		cd "$linux_dir"

		_exec "Packaging Linux headers" "make ARCH=$linux_arch INSTALL_HDR_PATH=$output/linux-headers/files/opt headers_install"
	fi

	# binutils
	_compile_pkg "$output/binutils/files/opt" "$binutils_dir" "Configuring Binutils" "$dev_stuff" "Compiling Binutils" "" "Packaging Binutils" "install-strip DESTDIR=$output/binutils/files"

	# bash
	_compile_pkg "$output/bash/files/opt" "$bash_dir" "Configuring GNU Bash" "$common_flags --disable-gnu-malloc" "Compiling GNU Bash" "" "Packaging GNU Bash" "install-strip DESTDIR=$output/bash/files"

	# make
	_compile_pkg "$output/make/files/opt" "$make_dir" "Configuring GNU Make" "$common_flags --without-guile" "Compiling GNU Make" "" "Packaging GNU Make" "install-strip DESTDIR=$output/make/files"

	# ncurses
	_compile_pkg "$output/ncurses/files/opt/lib/libncurses.so" "$ncurses_dir" "Configuring Ncurses" "$common_flags --with-cxx-shared --with-shared --enable-overwrite --with-termlib" "Compiling Ncurses" "" "Packaging Ncurses" "install DESTDIR=$output/ncurses/files INSTALL_PROG='/usr/bin/install --strip-program=$compile_target-strip -c -s'"
	if [ -r "$ncurses_dir/build" ]; then
		_exec "Cleaning Ncurses" "rm -rf $ncurses_dir/build"
	fi
	_compile_pkg "$output/ncurses/files/opt/lib/libncursesw.so" "$ncurses_dir" "Configuring NcursesW" "$common_flags --with-cxx-shared --with-shared --enable-overwrite --with-termlib --enable-widec" "Compiling NcursesW" "" "Packaging NcursesW" "install DESTDIR=$output/ncurses/files INSTALL_PROG='/usr/bin/install --strip-program=$compile_target-strip -c -s'"

	# nano
	_compile_pkg "$output/nano/files/opt" "$nano_dir" "Configuring Nano" "$common_flags --enable-tiny --enable-utf8" "Compiling Nano" "" "Installing Nano" "install DESTDIR=$output/ncurses/files"

	_rootfs_cleanup

	printf "Creating packages..."
	for i in $dist-libc-headers libstdc++ gcc linux-headers binutils bash make ncurses nano; do
		cd "$output/$i"
		tar cf files.tar files
		sha256sum files.tar > files.tar.sha256sum
		printf "$i\n$(_generate_stuff pkg_ver $i)\n$arch\n" > pkg_info

		tar cf ../$i.tar files.tar files.tar.sha256sum pkg_info
		bzip2 ../$i.tar
		mv ../$i.tar.bz2 ../$i.plpak
		printf "."
	done
	echo "Done."
}

compile_kernel(){
	_get_pkg_names
	cd "$linux_dir"

	if [ ! -f .config ]; then
		echo "Error: Kernel has not been configured yet. Run $0 --config-kernel and try again"
		exit 4
	fi

	script -qeac "make CROSS_COMPILE=$compile_target- ARCH=$linux_arch -j$threads" "$logfile"

	modules_support=$(grep -w "CONFIG_MODULES" .config)
	if [ "$modules_support" != "" ] && [ "$(echo $modules_support | grep '#')" = "" ]; then
		script -qeac "make CROSS_COMPILE=$compile_target- ARCH=$linux_arch INSTALL_MOD_PATH=$output_rootfs modules_install" "$logfile"
	fi
	cp arch/$linux_arch/boot/dts/*.dtb "$output" 2>/dev/null || true
	cp arch/$linux_arch/boot/*Image "$output"
}

compile_bootloader(){
	_get_pkg_names

	_compile_pkg "$toolchain_prefix/sbin/$compile_target-grub-install" "$grub_dir" "Configuring GRUB" "--prefix=$toolchain_prefix --target=$compile_target --program-prefix=$compile_target- --with-platform=$grub_platform" "Compiling GRUB" "" "Installing GRUB Tools" "install"
	cp $grub_dir/build/grub-install ~/cross/bin/toolchain-grub-install
}

echo "PortaLinux Build System v0.09"
printf "(c) 2022 pocketlinux32 & raisinware, Under GPLv2+\n\n"

if [ $# -eq 0 ]; then
	echo "Error: No command given. Run $0 --help for a list of supported commands"
	exit 1
fi

trap "_exit_handler" EXIT INT HUP

while [ $# -gt 0 ]; do
	case $1 in
		"--init")
			source "$plfiles/compile-modules/pkg/init.sh"
			_runtime_calc start
			_init "$2" $3
			_runtime_calc stop
			exit 0
			;;
		"--target-system")
			_target_system $2
			shift
			;;
		"--toolchain-prefix")
			toolchain_prefix="$2"
			shift
			;;
		"--test")
			set +e
			case $2 in
				toolchain)
					$compile_target-gcc --version
					;;
				pkg_parser)
					if [ ! -r "$build" ]; then
						echo "Error: You haven't initialized yet! Run $0 --init and try again"
						exit 6
					fi

					_get_pkg_names
					printf "$linux_dir\n$binutils_dir\n$gcc_dir\n$gmp_dir\n$mpc_dir\n$mpfr_dir\n$libc_dir\n$coreutils_dir\n$bash_dir\n"
					;;
				defconfig)
					if [ "$3" != "" ]; then
						kdefconfig=$4
					fi

					echo "Default config is $kdefconfig"
					;;
				build-all-t*)
					toolchain-prefix="$HOME/test"

					for i in pc earm earm64; do
						logfile="$pldir/log-$i/"
						_target_system $i
						setup_toolchain
						_pl_clean soft
					done

					_target_system i486-gnu
					_init

					for i in pc64 aarch64-gnu i686-gnu armv7-gnu; do
						logfile="$pldir/log-$i/"
						_target_system $i
						setup_toolchain
						_pl_clean soft
					done
					;;
			esac
			exit 0
			;;
		"--clean")
			_runtime_calc start
			_pl_clean soft $2
			_runtime_calc stop
			exit 0
			;;
		"--hard-clean")
			_runtime_calc start
			_pl_clean hard $2
			_runtime_calc stop
			exit 0
			;;
		"--threads")
			threads=$2
			shift
			;;
		"--build")
			action=$2
			if [ "$2" = "boot-img" ] && [ "$3" != "" ]; then
				compression="$3"
			fi
			shift
			;;
		"--config-kernel")
			_get_pkg_names
			cd "$linux_dir"

			if [ "$2" != "" ]; then
				kdefconfig=$2
			fi

			if [ ! -f .config ]; then
				make CROSS_COMPILE=$compile_target- ARCH=$linux_arch $kdefconfig
			fi

			make ARCH=$linux_arch menuconfig
			exit 0
			;;
		"--log-file")
			logfile=$2
			shift
			;;
		"--install-bootloader")
			#
			;;
		"--help")
			printf "Usage: $0 {--target-system|--threads} [--init|--clean|--hard-clean|--build] [value]\n\n"
			echo "--init					Initializes the build system by downloading necessary components and unpacking them"
			echo "--target-system [arch-dist]		Specifies the CPU architecture and the C library to be used. Default: i486-musl"
			echo "--toolchain-prefix [path]		Sets the target system's toolchain's install directory. Default: ~/cross"
			echo "--clean [lvl]				Cleans the build directory"
			echo "--hard-clean [no-rm-tarballs]		Removes any directories created by $0"
			echo "--threads [n]				Sets the amount of threads to be used in compilation"
			echo "--config-kernel				Configures the Linux kernel"
			echo "--build [action] [option]		Compiles toolchain, rootfs, extra-pkgs, kernel or boot-img. The previous list of words are the supported operations."
			exit 0
			;;
		*)
			echo "Error: Unrecognized command. Run $0 --help for a list of supported commands."
			exit 2
			;;
	esac
	shift
done

echo "Log file: $logfile"
echo "Target System: $compile_target"
printf "Toolchain install directory: $toolchain_prefix\n\n"
_runtime_calc start
case $action in
	toolchain)
		setup_toolchain
		;;
	rootfs)
		compile_rootfs
		;;
	extra-pkgs)
		compile_extra_pkgs
		;;
	kernel)
		compile_kernel
		;;
	boot-img)
		create_boot_image
		;;
	bootloader)
		compile_bootloader
		;;
	*)
		echo "Error: Unknown build command. Run $0 --help for a list of supported commands."
		exit 4
		;;
esac
_runtime_calc stop
exit 0
